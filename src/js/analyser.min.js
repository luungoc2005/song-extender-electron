function getIndex(r){for(var e=0;t[e]<r;)e++;return e}function getTime(r){return r*fft_size/sample_rate}function snapToHighest(r){for(var e=-1,t=Math.max(r-snapDistance,0);t<Math.min(r+snapDistance,totalEnergy.length);t++)(e==-1||totalEnergy[e]<totalEnergy[t])&&(e=t);return e==-1?r:e}function snapToLowest(r){for(var e=-1,t=Math.max(r-snapDistance,0);t<Math.min(r+snapDistance,totalEnergy.length);t++)(e==-1||totalEnergy[e]>totalEnergy[t])&&(e=t);return e==-1?r:e}function createArray(r){return Array.apply(null,Array(r)).map(Number.prototype.valueOf,0)}function totalTime(){return Math.floor(fftResult.length/samples)}function fftArrayAt(r){return fftResult.slice(r,r+analyseDist)}function diffScore(r,e){for(var t=Math.abs,a=correction,s=0,n=0;n<analyseDist;n++)for(var i=fftResult[r+n],o=fftResult[e+n],l=0;l<ranges;l++)null!=a[l]&&(s+=t(i[l]-o[l])*a[l]);return s}function isArrayEqual(r,e){if(r.length!=e.length)return!1;if(0==r.length)return!0;for(var t=0;t<r.length;t++)if(r[t]!=e[t])return!1;return!0}function isArraySimilar(r,e){if(r.length!=e.length)return!1;if(0==r.length)return!1;for(var t=0;t<r.length;t++)if(Math.abs(r[t]-e[t])>minDistance)return!1;return!0}function timeExists(r,e){if(0!=similar.length)for(var t=0;t<similar.length;t++){if(isArrayEqual(similar[t],[e,r]||isArrayEqual(similar[t],[r,e])))return t;if(isArraySimilar(similar[t],[r,e])||isArraySimilar(similar[t],[e,r]))return t}return-1}const r=require("events").EventEmitter,e=require("util"),t=[20,40,80,160,300,511];var ranges=t.length;var fftResult=[],minEnergy=[],totalEnergy=[],isBeat=[],scores=[],correction=[],pow_=[],avg_=[],fft_size=0,sample_rate=0,samples=0,minDistance=3,analyseDist=3,snapDistance=3,avgScore=0,minScore=0,maxScore=0,similar=[],similarGroups=[],FFTAnalyser=function(e,t){fft_size=t,sample_rate=e.sampleRate,samples=e.sampleRate/t,fftResult=[],scores=[],similar=[],correction=createArray(ranges),pow_=createArray(ranges),avg_=createArray(ranges),initial=createArray(ranges);for(var a=0;a<initial.length;a++)initial[a]=-1;minDistance=Math.round(7*samples),analyseDist=Math.round(2*samples),maxScore=0,minScore=0,avgScore=0,r.call(this)};e.inherits(FFTAnalyser,r),module.exports=FFTAnalyser,FFTAnalyser.prototype.fftAvailable=function(r){for(var e=createArray(ranges),t=createArray(ranges),a=r.fft,s=0;s<a.length;s++){var n=getIndex(s);n<ranges&&(pow_[n]+=a[s],a[s]>t[n]&&(e[n]=s,t[n]=a[s]))}fftResult.push(e),totalEnergy.push(r.total)},FFTAnalyser.prototype.fftClear=function(){fftResult=[]},FFTAnalyser.prototype.calculateBeats=function(){for(var r=0,e=0,t=Math.round(samples),a=[],s=0;s<totalEnergy.length;s++)if(a.push(totalEnergy[s]),a.length>t){a.shift();for(var n=0;n<a.length;n++)r+=a[n];r/=a.length;for(var i=0;i<a.length;i++){var o=a[i]-r;e+=o*o}e/=a.length;var l=-1e-15*e+1.2596,c=l*r;totalEnergy[s]>=c?isBeat.push(1):isBeat.push(0)}else isBeat.push(0)},FFTAnalyser.prototype.calculateCorrection=function(){for(var r=0,e=0;e<fftResult.length;e++)for(r=0;r<fftResult[e].length;r++)avg_[r]+=fftResult[e][r];for(var t=fftResult.length*fft_size,a=0;a<avg_.length;a++)avg_[a]/=fftResult.length,pow_[a]/=t;for(var s=0;s<fftResult.length;s++)for(r=0;r<fftResult[s].length;r++){var n=fftResult[s][r]-avg_[r];correction[r]+=n*n}for(var i=0;i<correction.length;i++)correction[i]/=fftResult.length,correction[i]=Math.sqrt(correction[i]),correction[i]=1/correction[i]*(pow_[i]/pow_[0]);console.log(pow_)},FFTAnalyser.prototype.calculateScores=function(){var r=fftResult.length;Math.abs;console.log("Calculating correction vector"),this.calculateCorrection(),console.log(`correction: ${JSON.stringify(correction)}`),console.log("Calculating scores");var e=r-analyseDist,t=``;scores=createArray(e);for(var a=0;a<e;a++){for(var s=createArray(e),n=a+1;n<e;n++){var i=0;n-a>analyseDist&&(i=diffScore(a,n),avgScore+=i,s[n]=i),0!=i&&(n-a>=analyseDist&&(0==minScore||i<minScore)&&(t=`${a/samples}s and ${n/samples}s`,minScore=i),(0==maxScore||i>maxScore)&&(maxScore=i))}scores[a]=s,this.emit("calc-progress",a/e*100)}avgScore/=(e-1)*(e-1),console.log(`Max score: ${maxScore}, Min score: ${minScore}, Average score: ${avgScore} - min at: ${t}, Samples per second: ${samples}`),this.emit("scores-calculated",scores);var o=1;for(o=1;o<20&&!(this.calculatePaths(o/100)>=5);o++);this.emit("paths-calculated",{groups:similar.sort(function(r,e){return r.time2>e.time2?1:r.time2<e.time2?-1:0}),total:Math.round(fftResult.length/samples),cutoff:o})},FFTAnalyser.prototype.calculatePaths=function(r){Math.abs;similarGroups=[],similar=[];var e=fftResult.length-analyseDist,t=minScore+(maxScore-minScore)*r;console.log(`Calculating paths - Cut off: ${minScore} - ${maxScore} => ${t} (${r})`);for(var a=0;a<e;a++)for(var s=a+1;s<e;s++)if(s-a>minDistance&&scores[a][s]&&scores[a][s]<=t){var n=a,i=s,o=[n,i];if(similarGroups){for(var l=!1,c=0;c<similarGroups.length;c++)for(var f=0;f<similarGroups[c].length;f++){if(isArraySimilar(similarGroups[c][f],o)){similarGroups[c].push(o),l=!0;break}if(l)break}l||similarGroups.push([o])}else similarGroups.push([o])}if(similarGroups.length>0)for(var u=0;u<similarGroups.length;u++){for(var g=-1,m=-1,h=0;h<similarGroups[u].length;h++){var p=similarGroups[u][h];(m==-1||scores[p[0]][p[1]]<m)&&(m=scores[p[0]][p[1]],g=h)}var y=similarGroups[u][g];similar.push({time1:getTime(y[0]),time2:getTime(y[1])})}return console.log(similar),similar.length};